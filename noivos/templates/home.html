{% extends 'base.html' %}
{% block 'body' %}
{% load static %}

<style>
    :root {
        --primary-color: #be1c3c; /* Vermelho romântico */
        --secondary-color: #8B4513; /* Marrom madeira */
        --accent-color: #f8e1e7; /* Rosa claro */
        --text-color: #333333;
        --light-text: #ffffff;
    }

    body {
        font-family: 'Montserrat', sans-serif;
        color: var(--text-color);
        background-color: #f9f9f9;
    }

    h2, h3, h4, h5, h6 {
        font-family: 'Playfair Display', serif;
        font-weight: 700;
        color: var(--secondary-color);
    }

    /* Hero Section */
    .hero-section {
        background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), 
                    url("{% if imagem %}{{ imagem.url }}{% else %}{% static 'noivos/img/aliancas.jpg' %}{% endif %}");
        background-size: cover;
        background-position: center;
        min-height: 100vh; /* Alterado para viewport height */
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        color: white;
        padding: 60px 20px; /* Reduzi o padding */
        margin-bottom: 50px;
        position: relative;
    }


    .hero-content {
        max-width: 800px;
        margin: 0 auto;
    }

    .couple-names {
        font-size: 3rem;
        font-weight: 400;
        margin-bottom: 20px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .wedding-date {
        font-size: 1.5rem;
        margin-bottom: 30px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    /* Countdown Timer */
    .countdown-container {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 30px;
    }

    .countdown-box {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(5px);
        border-radius: 10px;
        padding: 15px;
        min-width: 80px;
        text-align: center;
        width: 100px;
        
    }

    .countdown-value {
        font-size: 2rem;
        font-weight: 700;
        color: white;
        line-height: 1;
    }

    .countdown-label {
        font-size: 0.6rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: white;
        margin-top: 5px;
    }

    /* Form Section */
    .form-section {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        padding: 30px;
        margin-bottom: 40px;
    }

    .form-label {
        font-weight: 600;
        color: var(--primary-color);
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        padding: 12px 30px;
        font-weight: 600;
        border-radius: 50px;
        transition: all 0.3s;
    }

    .btn-primary:hover {
        background-color: #a01632;
        border-color: #a01632;
        transform: translateY(-2px);
    }

    /* Cards */
    .presente-card {
        border: none;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        transition: all 0.3s;
        height: 100%;
    }

    .presente-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.1);
    }

    .card-img-container {
        height: 200px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
    }

    .card-img-container img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    .edit-icon {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(255, 255, 255, 0.9);
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-color);
        transition: all 0.3s;
    }

    .edit-icon:hover {
        transform: scale(1.1);
        background: white;
    }

    /* Gallery */
    .gallery-item {
        position: relative;
        overflow: hidden;
        border-radius: 15px;
        height: 250px;
    }

    .gallery-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s;
    }

    .gallery-item:hover img {
        transform: scale(1.05);
    }

    .foto-quadrada {
            width: 100%;
            height: 310px;  /* Ajuste a altura conforme necessário */
            position: relative;
            overflow: hidden;
        }

        .foto-quadrada img {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .overlay-icon {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(0, 0, 0, 0.5);
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: all 0.3s;
    }

    .overlay-icon:hover {
        background: rgba(0, 0, 0, 0.7);
    }

    /* About Section */
    .about-card {
        text-align: center;
        margin-bottom: 30px;
    }

    .about-image {
        width: 350px;
        height: 350px;
        border-radius: 50%;
        object-fit: cover;
        border: 5px solid white;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        margin: 0 auto 20px;
    }

    /* Messages Section */
    .messages-container {
        max-height: 500px;
        overflow-y: auto;
        padding-right: 15px;
    }

    .message-box {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }

    /* Map Section */
    #map {
        height: 400px;
        width: 100%;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    /* Footer */
    footer {
        background: var(--secondary-color);
        color: white;
        padding: 40px 0 20px;
        text-align: center;
        margin-top: 50px;
    }

    .footer-couple-name {
        font-size: 1.5rem;
        font-weight: 400;
        margin-bottom: 10px;
    }

    .footer-date {
        font-size: 1rem;
        margin-bottom: 20px;
    }

    .footer-copyright {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    /* Scroll to top button */
    #scrollToTopBtn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--primary-color);
        color: white;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 9999; /* Valor alto para garantir que fique acima de tudo */
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #scrollToTopBtn.show {
        opacity: 1;
    }

    /* Responsividade */
    @media (max-width: 992px) {
        .couple-names {
            font-size: 2.5rem;
        }
        
        .wedding-date {
            font-size: 1.2rem;
        }
    }

    @media (max-width: 768px) {
        .couple-names {
            font-size: 2rem;
        }
        
        .countdown-box {
            min-width: 70px;
            padding: 10px;
        }
        
        .countdown-value {
            font-size: 1.5rem;
        }
        
        .about-image {
            width: 200px;
            height: 200px;
        }
    }

    /* Ajuste SOMENTE para celulares (max-width: 576px) */
    @media (max-width: 576px) {
        .countdown-container {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2 colunas */
            gap: 10px;
            max-width: 220px; /* Largura total para 2 colunas */
            margin-left: auto;
            margin-right: auto;
        }
        
        .countdown-box {
            width: 100%; /* Ocupa toda a largura da célula do grid */
            min-width: auto;
            padding: 10px;
        }
        
        .countdown-value {
            font-size: 1.5rem !important;
        }
        
        .countdown-label {
            font-size: 0.7rem !important;
        }
    }
</style>

{% include "partials/navbar.html" %}

        <!-- Hero Section -->
        <section class="hero-section">
            <div class="hero-content">
                <h1 class="text-uppercase display-4 mb-4 text-white">{{ nome_primeiro_conjuge }} & {{ nome_segundo_conjuge }}</h1>
                <p class="wedding-date text-white">{{ data_casamento|date:"d/m/Y" }} • {{ horario_casamento|time:"H:i" }}</p>
                
                <div class="countdown-container">
                    <div class="countdown-box">
                        <div class="countdown-value" id="dias">00</div>
                        <div class="countdown-label">Dias</div>
                    </div>
                    <div class="countdown-box">
                        <div class="countdown-value" id="horas">00</div>
                        <div class="countdown-label">Horas</div>
                    </div>
                    <div class="countdown-box">
                        <div class="countdown-value" id="minutos">00</div>
                        <div class="countdown-label">Minutos</div>
                    </div>
                    <div class="countdown-box">
                        <div class="countdown-value" id="segundos">00</div>
                        <div class="countdown-label">Segundos</div>
                    </div>
                </div>
            </div>
        </section>
        
        <div class="container">
            <section>
                <!-- Presentes Section -->
                <div class="form-section">
                    <div class="row">
                        <div class="col-lg-6">
                            <h2 class="Comfortaa-Bold text-center text-4xl font-semibold cor-marrom mb-4">Crie sua lista de presentes</h2>
                            {% if not tem_presentes and tem_lista_padrao %}
                                <div class="text-center mb-4">
                                    <form action="{% url 'importar_lista_padrao' %}" method="POST">
                                        {% csrf_token %}
                                        {% if not tem_presentes and tem_lista_padrao %}
                                            <div class="text-center mb-4">
                                                <a href="{% url 'selecionar_presentes_prontos' %}" class="btn btn-lg btn-success">
                                                    <i class="bi bi-download me-2"></i> Usar Lista de Presentes Pronta
                                                </a>
                                                <p class="mt-2 text-muted">Importe nossa lista sugerida de presentes para começar</p>
                                            </div>
                                        {% endif %}
                                        
                                    </form>
                                </div>
                                {% endif %}
                            <form action="{% url 'home' %}" method="POST" enctype="multipart/form-data">
                                {% csrf_token %}
                                
                                <div class="mb-3">
                                    <label for="nome_presente" class="form-label cor-marrom">Nome do presente</label>
                                    <input type="text" name="nome_presente" class="form-control" id="nome_presente">
                                </div>
                        
                                <div class="mb-3">
                                    <label for="link_presente" class="form-label cor-marrom">Link do presente</label>
                                    <div class="input-group">
                                        <input type="url" name="link_sugestao_compra" class="form-control" id="link_presente" placeholder="Insira o link do produto">
                                        <button type="button" id="buscar_detalhes" class="btn btn-danger rounded-pill">Buscar</button>
                                    </div>
                                </div>
                        
                                <!-- Área para exibir a miniatura da imagem -->
                                <div class="mb-3 text-center">
                                    <img id="preview_imagem" src="" alt="Imagem do produto" class="img-thumbnail mt-2 d-none" style="width: 128px; height: 128px;">
                                </div>
                        
                                <div class="mb-3">
                                    <label for="link_cobranca" class="form-label cor-marrom">Link de cobrança</label>
                                    <input type="url" name="link_cobranca" class="form-control" id="link_cobranca" placeholder="Insira o link para cobrança">
                                </div>
                        
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="foto_presente" class="form-label cor-marrom">Foto de exemplo</label>
                                        <input type="file" name="foto" class="form-control" id="foto_presente">
                                        <img id="preview_imagem_upload" class="img-thumbnail mt-2 d-none" style="width: 128px; height: 128px;">
                                        <input type="hidden" name="imagem_url" id="imagem_url">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="preco_presente" class="form-label cor-marrom">Preço estimado</label>
                                        <input type="text" name="preco" class="form-control" id="preco_presente">
                                    </div>
                                </div>
                        
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="importancia" class="form-label cor-marrom">Importância</label>
                                        <input type="range" min="1" max="5" name="importancia" class="form-range" id="importancia">
                                    </div>
                                    <div class="col-md-6 d-flex align-items-end">
                                        <button type="submit" class="btn btn-danger w-100 rounded-pill">Enviar</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <div class="col-lg-6 mt-4 mt-lg-0">
                            <div class="h-100 d-flex align-items-center justify-content-center">
                                <canvas id="myChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section>
                <br>

                <h2 class="Comfortaa-Bold text-center display-4 cor-marrom">Lista de presentes</h2>

                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mt-4">
                    {% for presente in presentes %}
                    <div class="col">
                        <div class="card h-100 position-relative">
                            <!-- Container da imagem com altura fixa e proporção quadrada -->
                            <div class="card-img-container" style="height: 200px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                                {% if presente.foto %}
                                <img src="{{ presente.foto.url }}" alt="{{ presente.nome_presente }}" class="card-img-top" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                                <!-- Ícone de edição -->
                                <a href="#" class="edit-icon" onclick="abrirModal(
                                    '{{ presente.id }}', 
                                    '{{ presente.nome_presente }}', 
                                    '{{ presente.link_sugestao_compra }}', 
                                    '{{ presente.link_cobranca }}', 
                                    '{{ presente.preco }}'
                                )">
                                    <i class="fas fa-edit"></i>
                                </a>
                                {% else %}
                                <div class="d-flex align-items-center justify-content-center h-100 bg-light">
                                    <p class="text-muted">Sem imagem</p>
                                </div>
                                {% endif %}
                            </div>
                
                            <!-- Corpo do card -->
                            <div class="card-body d-flex flex-column">
                                <h3 class="card-title cor-vermelho">{{ presente.nome_presente }}</h3>
                                <p class="card-text cor-vermelho">Valor: R$ {{ presente.preco|floatformat:2 }}</p>
                                {% if presente.reservado %}
                                <p class="card-text cor-marrom">Reservado por: {{ presente.reservado_por }}</p>
                                {% endif %}
                                {% if presente.link_sugestao_compra %}
                                <a href="{{ presente.link_sugestao_compra }}" target="_blank" class="cor-vermelho text-decoration-underline">
                                    Veja a sugestão de compra
                                </a>
                                {% endif %}
                                <div class="mt-2">
                                    {% if presente.importancia <= 2 %}
                                    <span class="importance-label low">
                                        Pouco importante
                                        <i class="fas fa-times-circle ms-1"></i>
                                    </span>
                                    {% elif presente.importancia < 4 %}
                                    <span class="importance-label medium">
                                        Importante
                                        <i class="fas fa-times-circle ms-1"></i>
                                    </span>
                                    {% else %}
                                    <span class="importance-label high">
                                        Muito importante
                                        <i class="fas fa-times-circle ms-1"></i>
                                    </span>
                                    {% endif %}
                                </div>
                                <!-- Formulário de exclusão -->
                                <form action="{% url 'excluir_presente' presente.id %}" method="POST" onsubmit="return confirmarExclusao();" class="mt-auto">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-danger btn-sm w-100 rounded-pill">
                                        Excluir
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Modal de Edição -->
                <div id="editPresenteModal" class="modal fade" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title cor-vermelho">Editar Presente</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editPresenteForm" method="POST">
                                    {% csrf_token %}
                                    <input type="hidden" id="presenteId" name="presente_id">
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Nome do presente</label>
                                        <input type="text" id="editNome" name="nome_presente" class="form-control">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Link de sugestão de compra</label>
                                        <input type="url" id="editLinkSugestao" name="link_sugestao_compra" class="form-control">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Link de cobrança</label>
                                        <input type="url" id="editLinkCobranca" name="link_cobranca" class="form-control">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Preço estimado</label>
                                        <input type="text" id="editPreco" name="preco" class="form-control">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" form="editPresenteForm" class="btn btn-primary">Salvar alterações</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <br>
            <br>

            <section>
                <!-- Presentes Reservados -->
                <div class="form-section">
                    <h2 class="Comfortaa-Bold text-center display-4 cor-marrom mb-4">Presentes Reservados</h2>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Presente</th>
                                    <th>Reservado por</th>
                                    <th class="text-end">Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for presente in presentes_reservados %}
                                <tr>
                                    <td>{{ presente.nome_presente }}</td>
                                    <td>{{ presente.reservado_por }}</td>
                                    <td class="text-end">R$ {{ presente.preco|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="2" class="text-end fw-bold">Total</td>
                                    <td class="text-end fw-bold">R$ {{ total_reservado|floatformat:2 }}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </section>

            <br>
            <br>

            <section>
                <!-- Galeria de Fotos -->
                <div class="form-section">
                    <h2 class="Comfortaa-Bold text-center text-4xl font-semibold cor-marrom mb-4">Galeria de fotos</h2>
                    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
                        {% for imagem in perfil.galeria.all|slice:":6" %}  <!-- Limita para 6 imagens -->
                            <div class="col">
                                <div class="foto-quadrada">
                                    <img src="{{ imagem.imagem.url }}" class="img-fluid rounded" alt="Imagem da galeria">
                                    <div class="overlay-icon">
                                        <a href="#" data-bs-toggle="modal" data-bs-target="#substituirImagemModal" data-id="{{ imagem.id }}" class="trocar-imagem">
                                            <i class="bi bi-pencil text-white"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <p class="text-center">Nenhuma imagem na galeria.</p>
                        {% endfor %}
                    </div>
                </div>

               
            </section>

            <br>
            <br>

            <section>
                <!-- Sobre Nós -->
                <div class="form-section">
                    <h2 class="Comfortaa-Bold text-center display-4 cor-marrom">Sobre nós</h2>
                    <div class="row">
                        <div class="col-md-6 mb-4 mb-md-0">
                            <div class="about-card">
                                <div class="position-relative">
                                    <img src="{{ imagem_noiva.url }}" class="about-image" alt="Noiva">
                                    <a href="#" class="overlay-icon" data-bs-toggle="modal" data-bs-target="#editarImagemModal" data-id="{{ imagem_noiva.id }}">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </div>
                                <h3>A Noiva</h3>
                                <p class="fst-italic">{{ mensagem_noiva }}</p>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="about-card">
                                <div class="position-relative">
                                    <img src="{{ imagem_noivo.url }}" class="about-image" alt="Noivo">
                                    <a href="#" class="overlay-icon" data-bs-toggle="modal" data-bs-target="#editarImagemModal" data-id="{{ imagem_noivo.id }}">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </div>
                                <h3>O Noivo</h3>
                                <p class="fst-italic">{{ mensagem_noivo }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editarMensagemModal">
                            <i class="bi bi-pencil me-2"></i> Editar Mensagens
                        </button>
                    </div>
                </div>

                <!-- Mensagem dos Noivos -->
                <div class="form-section">
                    <h2 class="Comfortaa-Bold display-4 cor-marrom mb-4 text-center">Mensagem</h2>
                    <p class="text-center lead">{{ perfil.mensagem_noivos }}</p>
                </div>

                <!-- Modal para editar mensagens -->
                <div class="modal fade" id="editarMensagemModal" tabindex="-1" aria-labelledby="editarMensagemModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editarMensagemModalLabel">Editar Mensagens</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                            </div>
                            <div class="modal-body">
                                <form method="POST" action="{% url 'editar_mensagem' %}">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <label for="mensagem_noiva" class="form-label">Mensagem sobre a Noiva</label>
                                        <textarea class="form-control" id="mensagem_noiva" name="mensagem_noiva" rows="3">{{ mensagem_noiva }}</textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="mensagem_noivo" class="form-label">Mensagem sobre o Noivo</label>
                                        <textarea class="form-control" id="mensagem_noivo" name="mensagem_noivo" rows="3">{{ mensagem_noivo }}</textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Salvar Mensagens</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal para editar imagem -->
                <div class="modal fade" id="editarImagemModal" tabindex="-1" aria-labelledby="editarImagemModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editarImagemModalLabel">Substituir fotos dos noivos</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                            </div>
                            <div class="modal-body">
                                <form method="POST" action="{% url 'substituir_imagem_noivos' %}" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <label for="imagem_noiva" class="form-label">Foto da noiva</label>
                                        <input type="file" class="form-control" id="imagem_noiva" name="imagem_noiva">
                                    </div>
                                    <div class="mb-3">
                                        <label for="imagem_noivo" class="form-label">Foto do noivo</label>
                                        <input type="file" class="form-control" id="imagem_noivo" name="imagem_noivo">
                                    </div>
                                    <button type="submit" class="btn btn-primary">Salvar Imagens</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal de Substituição de Imagem -->
                <div class="modal fade" id="substituirImagemModal" tabindex="-1" aria-labelledby="substituirImagemModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="substituirImagemModalLabel">Substituir Imagem</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>Escolha uma nova imagem para substituir.</p>
                                <input type="hidden" name="imagem_id" id="imagem_id">
                                <div class="row">
                                    {% for imagem in todas_imagens %}
                                        <div class="col-4 mb-3">
                                            <img src="{{ imagem.imagem.url }}" class="img-thumbnail select-image" 
                                                data-id="{{ imagem.id }}" data-url="{{ imagem.imagem.url }}" style="cursor:pointer;">
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mensagens Recebidas -->
                <div class="form-section">
                    <h2 class="Comfortaa-Bold display-4 cor-marrom text-center">Mensagens Recebidas</h2>
                    <div class="messages-container">
                        {% for mensagem in mensagens %}
                            <div class="message-box">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0 me-sm-3 mb-3 mb-sm-0 text-center">
                                        {% if mensagem.escrita_por.foto_perfil %}
                                            <img src="{{ mensagem.escrita_por.foto_perfil.url }}" alt="Foto do Convidado" class="rounded-circle shadow-sm" style="width: 55px; height: 55px; object-fit: cover;">
                                        {% else %}
                                            <div class="rounded-circle bg-info text-white d-flex align-items-center justify-content-center shadow-sm mx-auto" style="width: 55px; height: 55px; font-size: 30px;">
                                                <i class="fas fa-user"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <strong>{{ mensagem.escrita_por.nome_convidado }}</strong>
                                            <small class="text-muted">{{ mensagem.data_envio|date:"d/m/Y H:i" }}</small>
                                        </div>
                                        <p class="mb-0">{{ mensagem.texto_mensagem|safe }}</p>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <p class="text-center text-muted">Nenhuma mensagem recebida ainda.</p>
                        {% endfor %}
                    </div>
                </div>
            </section>

            <br>
            <br>

            <section>
                <div class="form-section">
                    <h2 class="Comfortaa-Bold display-4 cor-marrom mb-4 text-center"><i class="bi bi-geo-alt me-2"></i>Local</h2>
                    <p class="text-center mb-4">
                        {{ perfil.rua }}, {{ perfil.numero }} - {{ perfil.bairro }}<br>
                        {{ perfil.municipio }}/{{ perfil.estado }} - CEP: {{ perfil.cep }}
                    </p>
                    <div id="map" style="height: 400px;">
                        <noscript>
                            <div style="padding: 20px; text-align: center;">
                                <h3>Local do Casamento</h3>
                                <p>{{ perfil.rua }}, {{ perfil.numero }} - {{ perfil.bairro }}</p>
                                <p>{{ perfil.municipio }}/{{ perfil.estado }}</p>
                                <a href="https://www.openstreetmap.org/search?query={{ perfil.rua }} {{ perfil.numero }} {{ perfil.municipio }}" target="_blank">
                                    Ver no mapa
                                </a>
                            </div>
                        </noscript>
                    </div>
                </div>
            </section>
        </div>      
        <br>
    </div>
    
    
    <footer class="text-center bg-dark py-4">
        <!-- Copyright -->
        <div class="container">
            <div class="text-white fs-5">
                {{ perfil.nome_primeiro_conjuge }} & {{ perfil.nome_segundo_conjuge }}
            </div>
            <div class="text-white">
                {{ data_casamento|date:"d/m/Y" }}
            </div>
            <div class="text-white">
                © 2025 Todos os direitos reservados.
            </div>
        </div>
        <!-- Copyright -->
    </footer>

    <!-- Botão para rolar até o topo -->
    <button id="scrollToTopBtn" title="Voltar ao topo"><i class="bi bi-arrow-up"></i></button>  

    <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDJ1z7QJZsZiRmNL343rB2PayN-uBl4ZoA&callback=initMap&v={{ timestamp }}" async defer></script> -->

    <!-- Adicione estas bibliotecas no final do body, antes dos seus scripts -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
        function confirmarExclusao() {
            return confirm('Tem certeza que deseja excluir este presente?');
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        function abrirModal(id, nome, linkSugestao, linkCobranca, preco) {
            document.getElementById('presenteId').value = id;
            document.getElementById('editNome').value = nome;
            document.getElementById('editLinkSugestao').value = linkSugestao;
            document.getElementById('editLinkCobranca').value = linkCobranca;
            document.getElementById('editPreco').value = preco;

            const modal = new bootstrap.Modal(document.getElementById('editPresenteModal'));
            modal.show();
        }

        function fecharModal() {
            document.getElementById("editPresenteModal").classList.add("hidden");
        }


        // Substitua esta chave pela sua chave do GraphHopper
        const GRAPHHOPPER_API_KEY = '5281e92b-c1d9-42e2-bcb8-8f0eebb35e34';

        document.addEventListener("DOMContentLoaded", function() {
            // Configurar ícone personalizado
            const weddingIcon = L.icon({
                iconUrl: '{% static "noivos/img/wedding-marker.png" %}',
                iconSize: [38, 38],
                iconAnchor: [19, 38],
                popupAnchor: [0, -38]
            });
            
            // Função principal
            function initMap() {
                // Formatar endereço
                const endereco = `{{ perfil.rua }} {{ perfil.numero }}, {{ perfil.bairro }}, {{ perfil.municipio }}, {{ perfil.estado }}, Brasil`;
                
                // Criar mapa básico com fallback para Sabará, MG
                const map = L.map('map').setView([-19.8856, -43.8269], 12);
                
                // Adicionar camada do OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                // Adicionar loading state
                const loadingDiv = document.createElement('div');
                loadingDiv.style.position = 'absolute';
                loadingDiv.style.top = '50%';
                loadingDiv.style.left = '50%';
                loadingDiv.style.transform = 'translate(-50%, -50%)';
                loadingDiv.style.zIndex = '1000';
                loadingDiv.style.backgroundColor = 'rgba(255,255,255,0.8)';
                loadingDiv.style.padding = '10px 20px';
                loadingDiv.style.borderRadius = '5px';
                loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Carregando mapa...';
                document.getElementById('map').appendChild(loadingDiv);
                
                // Usar GraphHopper para geocoding
                fetch(`https://graphhopper.com/api/1/geocode?q=${encodeURIComponent(endereco)}&key=${GRAPHHOPPER_API_KEY}&limit=1`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        document.getElementById('map').removeChild(loadingDiv);
                        
                        if (data.hits && data.hits.length > 0) {
                            const location = data.hits[0];
                            const lat = location.point.lat;
                            const lon = location.point.lng;
                            
                            // Centralizar o mapa nas coordenadas encontradas
                            map.setView([lat, lon], 15);
                            
                            // Adicionar marcador
                            L.marker([lat, lon], {icon: weddingIcon}).addTo(map)
                                .bindPopup(`
                                    <div style="text-align:center;">
                                        <h4 style="margin-bottom:5px;">Local do Casamento</h4>
                                        <p style="margin-bottom:5px;">${location.name || endereco}</p>
                                        <p>{{ perfil.rua }}, {{ perfil.numero }} - {{ perfil.bairro }}</p>
                                        <a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=17/${lat}/${lon}" 
                                        target="_blank" 
                                        style="color: #d4a373; text-decoration:underline;">
                                            Ver no OpenStreetMap
                                        </a>
                                    </div>
                                `)
                                .openPopup();
                        } else {
                            // Mostrar mensagem de erro
                            const errorDiv = document.createElement('div');
                            errorDiv.style.padding = '20px';
                            errorDiv.style.textAlign = 'center';
                            errorDiv.innerHTML = `
                                <h4>Não foi possível encontrar o endereço exato</h4>
                                <p>Endereço pesquisado: ${endereco}</p>
                                <p>Mostrando localização aproximada de {{ perfil.municipio }}</p>
                            `;
                            document.getElementById('map').appendChild(errorDiv);
                        }
                    })
                    .catch(error => {
                        document.getElementById('map').removeChild(loadingDiv);
                        console.error('Erro ao geocodificar:', error);
                        
                        const errorDiv = document.createElement('div');
                        errorDiv.style.padding = '20px';
                        errorDiv.style.textAlign = 'center';
                        errorDiv.innerHTML = `
                            <h4>Erro ao carregar o mapa</h4>
                            <p>Por favor, verifique o endereço ou tente novamente mais tarde.</p>
                            <p>Endereço: ${endereco}</p>
                            <a href="https://www.openstreetmap.org/search?query=${encodeURIComponent(endereco)}" 
                            target="_blank" 
                            style="color: #d4a373; text-decoration:underline; font-weight:bold;">
                                Tentar no site do OpenStreetMap
                            </a>
                        `;
                        document.getElementById('map').appendChild(errorDiv);
                    });
            }
            
            // Inicializar o mapa
            initMap();
        });


        const ctx = document.getElementById('myChart');
    
        new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Não reservado', 'Reservado'],
            datasets: [{
            label: 'Presentes',
            data: JSON.parse('{{ data | safe }}'),
            backgroundColor: ['#8B4513', '#be1c3cfd'], // Cores personalizadas
            borderWidth: 1
            }]
        },
        options: {
            scales: {
            y: {
                beginAtZero: true
            }
            }
        }
        });




        const dataCasamento = "{{ data_casamento|date:'Y-m-d' }}";
        const horarioCasamento = "{{ horario_casamento|time:'H:i:s' }}";

        function iniciarContador() {
            if (!dataCasamento || !horarioCasamento) {
                console.error("A data ou o horário do casamento não foram fornecidos.");
                return;
            }

            // Criando a string completa da data e hora
            const casamentoDataHora = new Date(`${dataCasamento}T${horarioCasamento}`);
            const fim = casamentoDataHora.getTime();

            if (isNaN(fim)) {
                console.error("A data e hora do casamento são inválidas.");
                return;
            }

            const contador = setInterval(() => {
                const agora = new Date().getTime();
                const tempoRestante = fim - agora;

                if (tempoRestante <= 0) {
                    clearInterval(contador);
                    document.getElementById("timer").innerHTML = `
                        <div style="font-size: 2rem; font-weight: bold; color: green;">
                            O grande dia chegou!
                        </div>`;
                    return;
                }

                const tempo = {
                    dias: Math.floor(tempoRestante / (1000 * 60 * 60 * 24)),
                    horas: Math.floor((tempoRestante / (1000 * 60 * 60)) % 24),
                    minutos: Math.floor((tempoRestante / (1000 * 60)) % 60),
                    segundos: Math.floor((tempoRestante / 1000) % 60)
                };

                for (const unidade in tempo) {
                    document.getElementById(unidade).innerText = String(tempo[unidade]).padStart(2, '0');
                }
            }, 1000);
        }

        document.addEventListener("DOMContentLoaded", iniciarContador);


        // Função para preparar a substituição
        document.addEventListener("DOMContentLoaded", function () {
            let imagemSelecionada = null;

            document.querySelectorAll(".trocar-imagem").forEach(botao => {
                botao.addEventListener("click", function () {
                    imagemSelecionada = this.closest(".foto-quadrada").querySelector("img");
                    document.getElementById("imagem_id").value = this.dataset.id;
                });
            });

            document.querySelectorAll(".select-image").forEach(imagem => {
                imagem.addEventListener("click", function () {
                    if (imagemSelecionada) {
                        imagemSelecionada.src = this.dataset.url;
                        let formData = new FormData();
                        formData.append("imagem_id", document.getElementById("imagem_id").value);
                        formData.append("nova_imagem_id", this.dataset.id);

                        fetch("{% url 'substituir_imagem' %}", {
                            method: "POST",
                            body: formData,
                            headers: {
                                "X-CSRFToken": "{{ csrf_token }}"
                            }
                        }).then(response => response.json())
                        .then(data => {
                            if (data.sucesso) {
                                // Fecha o modal corretamente
                                let modal = document.getElementById("substituirImagemModal");
                                let modalInstance = bootstrap.Modal.getInstance(modal);
                                modalInstance.hide();

                                // Remove fundo escuro
                                document.querySelectorAll(".modal-backdrop").forEach(el => el.remove());
                                document.body.classList.remove("modal-open");

                                // Opcional: Recarrega a página para garantir atualização completa
                                setTimeout(() => {
                                    location.reload();
                                }, 500);
                            } else {
                                alert("Erro ao atualizar imagem.");
                            }
                        });
                    }
                });
            });
        });


        // Botão de scroll para o topo
        document.addEventListener("DOMContentLoaded", function() {
            const scrollToTopBtn = document.getElementById("scrollToTopBtn");
            
            // Mostrar ou esconder o botão quando o usuário rolar a página
            window.addEventListener('scroll', function() {
                if (window.pageYOffset > 300) { // Mostrar após rolar 300px
                    scrollToTopBtn.classList.add('show');
                } else {
                    scrollToTopBtn.classList.remove('show');
                }
            });
            
            // Rolagem suave quando o botão for clicado
            scrollToTopBtn.addEventListener('click', function(e) {
                e.preventDefault();
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        });


        document.addEventListener("DOMContentLoaded", function () {
            const btnBuscar = document.getElementById("buscar_detalhes");
            const inputLink = document.getElementById("link_presente");
            const inputNome = document.querySelector('input[name="nome_presente"]');
            const inputPreco = document.querySelector('input[name="preco"]');
            const imgPreview = document.getElementById("preview_imagem");

            btnBuscar.addEventListener("click", function () {
                const url = inputLink.value.trim();

                if (!url) {
                    alert("Por favor, insira um link do Mercado Livre.");
                    return;
                }

                fetch(`/noivos/buscar_produto/?url=${encodeURIComponent(url)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert(data.error);
                        } else {
                            inputNome.value = data.nome;
                            inputPreco.value = data.preco;
                            imgPreview.src = data.imagem; // Define a imagem retornada pela API
                            imgPreview.classList.remove("d-none"); // Exibe a imagem
                        }
                    })
                    .catch(error => console.error("Erro na requisição:", error));
            });
        });


       



    </script>
    
    
{% endblock %}